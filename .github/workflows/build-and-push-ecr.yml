name: Build & Push to ECR

on:
  push:
    branches: [dev, main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target env (affects tags)"
        type: choice
        default: dev
        options: [dev, prod]

concurrency:
  group: build-push-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write   # OIDC for AWS

env:
  AWS_REGION: us-west-1                 # <- set your region
  ECR_REPOSITORY: fabrion/jaeger-ui     # <- your ECR repo (can include a /)
  DOCKERFILE_PATH: ./Dockerfile         # <- adjust if needed
  BUILD_CONTEXT: .                      # <- adjust if needed

jobs:
  build-push:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Derive environment (dev/prod) from dispatch input or branch
      - name: Resolve target environment
        id: envsel
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          else
            case "${{ github.ref }}" in
              refs/heads/main) ENV="prod" ;;
              *)               ENV="dev"  ;;
            esac
          fi
          echo "ENVIRONMENT=$ENV" >> "$GITHUB_ENV"
          echo "Resolved ENVIRONMENT=$ENV"

      # Short-lived AWS creds via OIDC (no static keys)
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_CI_ROLE_TO_ASSUME }}   # e.g. arn:aws:iam::<acct>:role/GithubActionsECRPush
          aws-region: ${{ env.AWS_REGION }}

      # Login to ECR (secure; uses --password-stdin under the hood)
      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Compose full image name from ECR login output
      - name: Set image name
        run: |
          echo "REGISTRY=${{ steps.ecr.outputs.registry }}" >> "$GITHUB_ENV"
          echo "IMAGE=${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}" >> "$GITHUB_ENV"
          echo "Using IMAGE=$IMAGE"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE }}
          tags: |
            type=raw,value=${{ env.ENVIRONMENT }}
            type=raw,value=${{ env.ENVIRONMENT }}-${{ github.sha }}
            type=sha,format=long
          labels: |
            org.opencontainers.image.title=jaeger-ui
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ env.ENVIRONMENT }}

      - name: Build & push
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.BUILD_CONTEXT }}
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          # platforms: linux/amd64   # uncomment if you want to force amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Summary
        run: |
          {
            echo "## Pushed image"
            echo ""
            echo "**Registry:** ${{ env.REGISTRY }}"
            echo "**Repository:** ${{ env.ECR_REPOSITORY }}"
            echo "**Tags:**"
            echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n'
          } >> "$GITHUB_STEP_SUMMARY"
